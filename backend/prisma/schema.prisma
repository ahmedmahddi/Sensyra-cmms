// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE ENTITIES
// ============================================

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  logo        String?
  
  // Subscription
  plan        SubscriptionPlan @default(FREE)
  maxUsers    Int      @default(5)
  maxAssets   Int      @default(50)
  
  // Settings
  timezone    String   @default("Africa/Tunis")
  language    Language @default(FRENCH)
  currency    String   @default("TND")
  
  // Billing
  billingEmail String?
  
  // Metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  // Relations
  users             User[]
  workOrders        WorkOrder[]
  assets            Asset[]
  locations         Location[]
  teams             Team[]
  parts             Part[]
  vendors           Vendor[]
  customFields      CustomField[]
  procedures        Procedure[]
  inspections       Inspection[]
  workRequests      WorkRequest[]
  notifications     Notification[]
  apiKeys           ApiKey[]
  
  @@index([slug])
}

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Language {
  ARABIC
  FRENCH
  ENGLISH
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String
  
  firstName       String
  lastName        String
  phone           String?
  avatar          String?
  
  role            Role
  organizationId  String
  
  // Settings
  language        Language @default(FRENCH)
  timezone        String?
  
  // 2FA
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?
  
  // Status
  isActive        Boolean  @default(true)
  emailVerified   Boolean  @default(false)
  lastLoginAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  
  // Relations
  organization         Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedWorkOrders   WorkOrder[]        @relation("AssignedUser")
  createdWorkOrders    WorkOrder[]        @relation("CreatedBy")
  teams                TeamMember[]
  notifications        Notification[]
  workRequests         WorkRequest[]
  comments             Comment[]
  activityLogs         ActivityLog[]
  
  @@index([organizationId])
  @@index([email])
  @@index([role])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ENGINEER
  TECHNICIAN
  REQUESTER
}

// ============================================
// WORK ORDERS
// ============================================

model WorkOrder {
  id              String         @id @default(uuid())
  number          String         // Auto-generated: WO-2025-0001
  
  title           String
  description     String?
  
  priority        Priority       @default(MEDIUM)
  status          WorkOrderStatus @default(OPEN)
  category        String?        // Electrical, Plumbing, HVAC, etc.
  
  // Assignment
  assignedToId    String?
  assignedTeamId  String?
  
  // Asset
  assetId         String?
  locationId      String?
  
  // Scheduling
  dueDate         DateTime?
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  
  // Completion
  completedAt     DateTime?
  completionNotes String?
  
  // Time tracking
  estimatedHours  Float?
  actualHours     Float?
  
  // Cost tracking
  laborCost       Float?
  partsCost       Float?
  totalCost       Float?
  
  // PM related
  isPM            Boolean        @default(false)
  pmScheduleId    String?
  
  // Work Request
  workRequestId   String?        @unique
  
  organizationId  String
  createdById     String
  
  metadata        Json?          // Custom fields
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  
  // Relations
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTo      User?          @relation("AssignedUser", fields: [assignedToId], references: [id])
  assignedTeam    Team?          @relation(fields: [assignedTeamId], references: [id])
  asset           Asset?         @relation(fields: [assetId], references: [id])
  location        Location?      @relation(fields: [locationId], references: [id])
  pmSchedule      PMSchedule?    @relation(fields: [pmScheduleId], references: [id])
  workRequest     WorkRequest?   @relation(fields: [workRequestId], references: [id])
  createdBy       User           @relation("CreatedBy", fields: [createdById], references: [id])
  
  tasks           Task[]
  parts           WorkOrderPart[]
  comments        Comment[]
  attachments     Attachment[]
  checklists      WorkOrderChecklist[]
  statusHistory   WorkOrderStatusHistory[]
  
  @@unique([organizationId, number])
  @@index([organizationId, status])
  @@index([assignedToId])
  @@index([assetId])
  @@index([dueDate])
  @@index([createdAt])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model WorkOrderStatusHistory {
  id            String         @id @default(uuid())
  workOrderId   String
  fromStatus    WorkOrderStatus?
  toStatus      WorkOrderStatus
  changedById   String
  notes         String?
  createdAt     DateTime       @default(now())
  
  workOrder     WorkOrder      @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  @@index([workOrderId])
}

model Task {
  id            String   @id @default(uuid())
  workOrderId   String
  
  title         String
  description   String?
  order         Int      // Display order
  
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  completedById String?
  
  createdAt     DateTime @default(now())
  
  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  @@index([workOrderId])
}

// ============================================
// PREVENTIVE MAINTENANCE
// ============================================

model PMSchedule {
  id              String          @id @default(uuid())
  name            String
  description     String?
  
  assetId         String
  locationId      String?
  
  // Recurrence
  frequency       PMFrequency
  interval        Int             @default(1) // Every X days/weeks/months
  
  // Time-based
  nextDueDate     DateTime?
  lastCompletedAt DateTime?
  
  // Meter-based
  meterBased      Boolean         @default(false)
  meterThreshold  Float?
  lastMeterReading Float?
  
  // Assignment
  assignedToId    String?
  assignedTeamId  String?
  
  // Template
  procedureId     String?
  estimatedHours  Float?
  
  isActive        Boolean         @default(true)
  
  organizationId  String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?
  
  // Relations
  asset           Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  location        Location?       @relation(fields: [locationId], references: [id])
  procedure       Procedure?      @relation(fields: [procedureId], references: [id])
  
  workOrders      WorkOrder[]
  
  @@index([organizationId])
  @@index([assetId])
  @@index([nextDueDate])
}

enum PMFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  METER_BASED
}

// ============================================
// ASSETS
// ============================================

model Asset {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  // Identification
  assetTag        String?      // Unique identifier/barcode
  serialNumber    String?
  qrCode          String?      @unique
  
  category        String?      // Equipment, Vehicle, Facility, etc.
  manufacturer    String?
  model           String?
  
  // Location
  locationId      String?
  parentAssetId   String?      // For hierarchical assets
  
  // Lifecycle
  purchaseDate    DateTime?
  purchasePrice   Float?
  warrantyExpiry  DateTime?
  lifeExpectancy  Int?         // In months
  
  // Status
  status          AssetStatus  @default(OPERATIONAL)
  condition       String?      // Good, Fair, Poor
  
  // Meters (for meter-based PM)
  hasMeter        Boolean      @default(false)
  meterUnit       String?      // Hours, Kilometers, Cycles
  currentMeter    Float?
  
  // Documentation
  image           String?
  manualUrl       String?
  
  organizationId  String
  metadata        Json?        // Custom fields
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  location        Location?    @relation(fields: [locationId], references: [id])
  parentAsset     Asset?       @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets     Asset[]      @relation("AssetHierarchy")
  
  workOrders      WorkOrder[]
  pmSchedules     PMSchedule[]
  parts           AssetPart[]
  documents       Document[]
  meterReadings   MeterReading[]
  
  @@unique([organizationId, assetTag])
  @@index([organizationId])
  @@index([locationId])
  @@index([qrCode])
}

enum AssetStatus {
  OPERATIONAL
  DOWN
  MAINTENANCE
  RETIRED
}

model MeterReading {
  id        String   @id @default(uuid())
  assetId   String
  reading   Float
  unit      String
  notes     String?
  createdAt DateTime @default(now())
  
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  @@index([assetId, createdAt])
}

// ============================================
// LOCATIONS
// ============================================

model Location {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  // Hierarchy
  parentId        String?
  path            String?      // For hierarchical queries: /building/floor/room
  
  // Address
  address         String?
  city            String?
  state           String?
  postalCode      String?
  country         String       @default("Tunisia")
  
  // Coordinates
  latitude        Float?
  longitude       Float?
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent          Location?    @relation("LocationHierarchy", fields: [parentId], references: [id])
  children        Location[]   @relation("LocationHierarchy")
  
  assets          Asset[]
  workOrders      WorkOrder[]
  pmSchedules     PMSchedule[]
  
  @@index([organizationId])
  @@index([parentId])
}

// ============================================
// INVENTORY & PARTS
// ============================================

model Part {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  // Identification
  partNumber      String?
  barcode         String?
  
  category        String?
  manufacturer    String?
  
  // Inventory
  quantity        Float        @default(0)
  unit            String       // pcs, kg, liters, etc.
  minQuantity     Float?       // Reorder point
  maxQuantity     Float?
  
  // Pricing
  unitCost        Float?
  currency        String       @default("TND")
  
  // Location
  location        String?      // Warehouse location
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  workOrderParts  WorkOrderPart[]
  assetParts      AssetPart[]
  stockMovements  StockMovement[]
  
  @@index([organizationId])
  @@index([barcode])
}

model WorkOrderPart {
  id            String    @id @default(uuid())
  workOrderId   String
  partId        String
  
  quantity      Float
  unitCost      Float?
  totalCost     Float?
  
  createdAt     DateTime  @default(now())
  
  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  part          Part      @relation(fields: [partId], references: [id])
  
  @@index([workOrderId])
  @@index([partId])
}

model AssetPart {
  id        String   @id @default(uuid())
  assetId   String
  partId    String
  quantity  Float    @default(1)
  
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  part      Part     @relation(fields: [partId], references: [id])
  
  @@unique([assetId, partId])
}

model StockMovement {
  id          String         @id @default(uuid())
  partId      String
  
  type        MovementType
  quantity    Float
  
  // Before/After
  beforeQty   Float
  afterQty    Float
  
  // Reference
  referenceType String?      // WorkOrder, Adjustment, Purchase
  referenceId   String?
  
  notes       String?
  createdAt   DateTime       @default(now())
  
  part        Part           @relation(fields: [partId], references: [id], onDelete: Cascade)
  
  @@index([partId, createdAt])
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
}

// ============================================
// PROCEDURES & CHECKLISTS
// ============================================

model Procedure {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  category        String?
  estimatedTime   Float?       // In hours
  
  // Content
  steps           Json         // Array of {order, title, description, isChecklist}
  
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  pmSchedules     PMSchedule[]
  workOrderChecklists WorkOrderChecklist[]
  
  @@index([organizationId])
}

model WorkOrderChecklist {
  id            String    @id @default(uuid())
  workOrderId   String
  procedureId   String?
  
  name          String
  items         Json      // Array of {id, text, isCompleted, completedAt, completedBy}
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  procedure     Procedure? @relation(fields: [procedureId], references: [id])
  
  @@index([workOrderId])
}

// ============================================
// INSPECTIONS
// ============================================

model Inspection {
  id              String           @id @default(uuid())
  name            String
  description     String?
  
  assetId         String?
  locationId      String?
  
  // Schedule
  frequency       PMFrequency?
  nextDueDate     DateTime?
  
  // Status
  status          InspectionStatus @default(SCHEDULED)
  
  // Results
  passed          Boolean?
  score           Float?
  
  inspectedAt     DateTime?
  inspectedById   String?
  
  // Template
  items           Json             // Array of {id, question, type, required, value}
  
  organizationId  String
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([nextDueDate])
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// WORK REQUESTS
// ============================================

model WorkRequest {
  id              String              @id @default(uuid())
  title           String
  description     String?
  
  priority        Priority            @default(MEDIUM)
  status          WorkRequestStatus   @default(PENDING)
  
  locationId      String?
  assetId         String?
  
  requestedById   String
  
  // Conversion
  convertedToWorkOrder Boolean        @default(false)
  
  organizationId  String
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedBy     User                @relation(fields: [requestedById], references: [id])
  
  workOrder       WorkOrder?
  attachments     Attachment[]
  
  @@index([organizationId])
  @@index([requestedById])
  @@index([status])
}

enum WorkRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CONVERTED
}

// ============================================
// TEAMS
// ============================================

model Team {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  members         TeamMember[]
  workOrders      WorkOrder[]
  
  @@index([organizationId])
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  role      String?  // Lead, Member
  joinedAt  DateTime @default(now())
  
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
}

// ============================================
// VENDORS (FUTURE)
// ============================================

model Vendor {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  contactName     String?
  email           String?
  phone           String?
  website         String?
  
  address         String?
  city            String?
  country         String       @default("Tunisia")
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
}

// ============================================
// ATTACHMENTS & DOCUMENTS
// ============================================

model Attachment {
  id              String       @id @default(uuid())
  filename        String
  originalName    String
  mimeType        String
  size            Int          // bytes
  url             String
  
  // Specific Relations instead of Polymorphic
  workOrderId     String?
  workOrder       WorkOrder?   @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  workRequestId   String?
  workRequest     WorkRequest? @relation(fields: [workRequestId], references: [id], onDelete: Cascade)
  
  uploadedById    String?
  
  createdAt       DateTime     @default(now())
  deletedAt       DateTime?
  
  @@index([workOrderId])
  @@index([workRequestId])
}

model Document {
  id              String       @id @default(uuid())
  title           String
  description     String?
  
  type            String       // Manual, Warranty, Certificate, etc.
  
  filename        String
  url             String
  
  assetId         String
  
  expiryDate      DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  
  // Relations
  asset           Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  @@index([assetId])
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id            String    @id @default(uuid())
  content       String
  
  // Specific Relations
  workOrderId   String?
  workOrder     WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  authorId      String
  author        User      @relation(fields: [authorId], references: [id])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([workOrderId])
  @@index([authorId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id              String           @id @default(uuid())
  userId          String
  
  type            NotificationType
  title           String
  message         String
  
  // Reference
  entityType      String?
  entityId        String?
  
  // Channels
  readAt          DateTime?
  emailSent       Boolean          @default(false)
  smsSent         Boolean          @default(false)
  whatsappSent    Boolean          @default(false)
  
  organizationId  String
  
  createdAt       DateTime         @default(now())
  
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([userId, readAt])
  @@index([createdAt])
}

enum NotificationType {
  WORK_ORDER_ASSIGNED
  WORK_ORDER_COMPLETED
  WORK_ORDER_DUE
  PM_DUE
  INSPECTION_DUE
  PART_LOW_STOCK
  ASSET_DOWN
  COMMENT_ADDED
}

// ============================================
// ACTIVITY LOG
// ============================================

model ActivityLog {
  id              String   @id @default(uuid())
  action          String   // created, updated, deleted, completed
  
  // Entity
  entityType      String
  entityId        String
  
  // Changes
  before          Json?
  after           Json?
  
  userId          String
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// CUSTOM FIELDS
// ============================================

model CustomField {
  id              String       @id @default(uuid())
  name            String
  label           String
  fieldType       FieldType
  
  // Applied to
  entityType      String       // WorkOrder, Asset, Location
  
  // Options for select/multiselect
  options         Json?
  
  required        Boolean      @default(false)
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, entityType])
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  SELECT
  MULTISELECT
}

// ============================================
// API KEYS
// ============================================

model ApiKey {
  id              String       @id @default(uuid())
  name            String
  key             String       @unique
  
  scopes          String[]     // read:work_orders, write:assets, etc.
  
  lastUsedAt      DateTime?
  expiresAt       DateTime?
  
  organizationId  String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([key])
  @@index([organizationId])
}
